name: Deploy Backend

on:
  workflow_call:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Set service environment variables
        run: |
          railway variable set \
            "COOKIE_DOMAIN=${{ secrets.COOKIE_DOMAIN }}" \
            "CORS_ORIGINS=${{ secrets.CORS_ORIGINS }}" \
            "ENV=${{ secrets.ENV }}" \
            "FRONTEND_URL=${{ secrets.FRONTEND_URL }}" \
            "GITHUB_APP_ID=${{ secrets.GH_APP_ID }}" \
            "GITHUB_APP_PRIVATE_KEY=${{ secrets.GH_APP_PRIVATE_KEY }}" \
            "GITHUB_APP_SLUG=${{ secrets.GH_APP_SLUG }}" \
            "GITHUB_APP_WEBHOOK_SECRET=${{ secrets.GH_APP_WEBHOOK_SECRET }}" \
            "GITHUB_OAUTH_CLIENT_ID=${{ secrets.GH_OAUTH_CLIENT_ID }}" \
            "GITHUB_OAUTH_CLIENT_SECRET=${{ secrets.GH_OAUTH_CLIENT_SECRET }}" \
            "GITHUB_OAUTH_REDIRECT_URL=${{ secrets.GH_OAUTH_REDIRECT_URL }}" \
            "JWT_SECRET=${{ secrets.JWT_SECRET }}" \
            "PROMO_DEFAULT_PLAN=${{ secrets.PROMO_DEFAULT_PLAN }}" \
            "SECURE_COOKIE=${{ secrets.SECURE_COOKIE }}" \
            --service web-backend
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Deploy web-backend
        run: |
          cp infra/railway/web-backend/railway.json railway.json
          railway up --service web-backend --detach
          rm railway.json
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
