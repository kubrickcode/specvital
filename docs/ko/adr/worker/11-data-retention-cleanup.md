---
title: ë³´ì¡´ ê¸°ê°„ ê¸°ë°˜ ë°ì´í„° ì •ë¦¬ ì„œë¹„ìŠ¤
description: Railway Cron ê¸°ë°˜ ë…ë¦½ ë°”ì´ë„ˆë¦¬ë¥¼ í†µí•œ ìë™ ë°ì´í„° ë³´ì¡´ ì •ë¦¬ ADR
---

# ADR-11: ë³´ì¡´ ê¸°ê°„ ê¸°ë°˜ ë°ì´í„° ì •ë¦¬ ì„œë¹„ìŠ¤

> ğŸ‡ºğŸ‡¸ [English Version](/en/adr/worker/11-data-retention-cleanup.md)

| ë‚ ì§œ       | ì‘ì„±ì       | ë ˆí¬ì§€í† ë¦¬    |
| ---------- | ------------ | ------------- |
| 2026-02-02 | @KubrickCode | worker, infra |

## ì»¨í…ìŠ¤íŠ¸

### ë°ì´í„° ì¦ê°€ ë¬¸ì œ

Specvital í”Œë«í¼ì˜ ì‹œê°„ ê¸°ë°˜ ë°ì´í„° ëˆ„ì :

| ë°ì´í„° ìœ í˜• | í…Œì´ë¸”                  | ì¦ê°€ íŒ¨í„´        | ë³´ì¡´ í•„ìš”   |
| ----------- | ----------------------- | ---------------- | ----------- |
| ë¶„ì„ ì´ë ¥   | `user_analysis_history` | ì»¤ë°‹ë³„ ë¶„ì„      | í‹°ì–´ë³„ ë³´ì¡´ |
| ìŠ¤í™ ë¬¸ì„œ   | `spec_documents`        | SpecView ìƒì„±ë³„  | í‹°ì–´ë³„ ë³´ì¡´ |
| ë¶„ì„        | `analyses`              | ê³µìœ  ë¶„ì„ ë ˆì½”ë“œ | ê³ ì•„ ì •ë¦¬   |
| ì‚¬ìš© ì´ë²¤íŠ¸ | `usage_events`          | ì—°ì‚°ë³„ (ADR-13)  | ê°ì‚¬ + ì •ë¦¬ |
| í• ë‹¹ëŸ‰ ì˜ˆì•½ | `quota_reservations`    | ë™ì‹œ ìš”ì²­ë³„      | ë‹¨ê¸° (TTL)  |

ì ê·¹ì ì¸ ì •ë¦¬ ì—†ì´ëŠ” ìŠ¤í† ë¦¬ì§€ ë¹„ìš© ì¦ê°€ ë° ì¿¼ë¦¬ ì„±ëŠ¥ ì €í•˜ ë°œìƒ.

### ë³´ì¡´ ì •ì±… ìš”êµ¬ì‚¬í•­

êµ¬ë… í”Œëœë³„ í‹°ì–´ ê¸°ë°˜ ë³´ì¡´ ê¸°ê°„:

| í‹°ì–´       | ë³´ì¡´ ê¸°ê°„     | ê·¼ê±°                  |
| ---------- | ------------- | --------------------- |
| Free       | 30ì¼          | ë¹„ìš© í†µì œ             |
| Pro        | 90ì¼          | í‘œì¤€ ë¹„ì¦ˆë‹ˆìŠ¤ ìš”êµ¬    |
| Pro Plus   | 180ì¼         | í™•ì¥ ì´ë ¥             |
| Enterprise | ë¬´ì œí•œ (NULL) | ì»´í”Œë¼ì´ì–¸ìŠ¤ ìš”êµ¬ì‚¬í•­ |

### ë‹¤ìš´ê·¸ë ˆì´ë“œ ê³µì •ì„± ë¬¸ì œ

**ê³¼ì œ**: ì‚¬ìš©ìê°€ Proì—ì„œ Freeë¡œ ë‹¤ìš´ê·¸ë ˆì´ë“œ ì‹œ Pro í‹°ì–´ ë°ì´í„°(90ì¼ ë³´ì¡´)ë¥¼ ì¦‰ì‹œ ì‚­ì œí•´ì•¼ í•˜ëŠ”ê°€?

**ë‹µë³€**: ì•„ë‹ˆì˜¤. ìƒìœ„ í‹°ì–´ í”Œëœì—ì„œ ìƒì„±ëœ ë°ì´í„°ëŠ” ì›ë˜ ë³´ì¡´ ê¸°ê°„ ìœ ì§€. ë ˆì½”ë“œ ìƒì„± ì‹œì ì— ë³´ì¡´ ì •ì±… ìº¡ì²˜ í•„ìš” (ì •ë¦¬ ì‹œì  ì¡°íšŒê°€ ì•„ë‹˜).

### ì•„í‚¤í…ì²˜ ì»¨í…ìŠ¤íŠ¸

Scheduler ì„œë¹„ìŠ¤ ì œê±°([ADR-22](/ko/adr/22-scheduler-removal-railway-cron.md))ë¡œ ì¤‘ì•™ ì§‘ì¤‘ì‹ í¬ë¡  ì‹¤í–‰ê¸° íì§€. ê¸°ì¡´ Scheduler ë‚´ ì •ë¦¬ íƒœìŠ¤í¬ëŠ” Railway Cron ë°°í¬ë¡œ ì „í™˜.

## ê²°ì •

**ë°ì´í„° ë³´ì¡´ ì •ë¦¬ë¥¼ ë…ë¦½ ë°”ì´ë„ˆë¦¬(`cmd/retention-cleanup`)ë¡œ êµ¬í˜„, Railway Cron í†µí•´ ë§¤ì¼ UTC 03:00 íŠ¸ë¦¬ê±°.**

### ìƒì„± ì‹œì  ë³´ì¡´ ìŠ¤ëƒ…ìƒ·

ë ˆì½”ë“œ ìƒì„± ì‹œ `retention_days_at_creation` ì €ì¥:

```sql
ALTER TABLE user_analysis_history ADD COLUMN retention_days_at_creation integer;
ALTER TABLE spec_documents ADD COLUMN retention_days_at_creation integer;

-- ì œì•½ ì¡°ê±´: ì–‘ìˆ˜ ë˜ëŠ” NULL
CHECK ((retention_days_at_creation IS NULL) OR (retention_days_at_creation > 0))

-- ì •ë¦¬ ì¿¼ë¦¬ìš© ë¶€ë¶„ ì¸ë±ìŠ¤
CREATE INDEX idx_uah_retention_cleanup ON user_analysis_history (created_at)
WHERE (retention_days_at_creation IS NOT NULL);
```

**ê°’ ì˜ë¯¸ë¡ **:

| ê°’        | ì˜ë¯¸                            |
| --------- | ------------------------------- |
| NULL      | ë¬´ì œí•œ ë³´ì¡´ (enterprise/ë ˆê±°ì‹œ) |
| ì–‘ìˆ˜ ì •ìˆ˜ | ì‚­ì œ ëŒ€ìƒì´ ë˜ê¸°ê¹Œì§€ì˜ ì¼ìˆ˜     |

### 2ë‹¨ê³„ ì •ë¦¬ ì „ëµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ì •ë¦¬ ì‹¤í–‰ ìˆœì„œ                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Phase 1a: ë§Œë£Œëœ user_analysis_history ì‚­ì œ                     â”‚
â”‚            WHERE created_at + retention_days < NOW()             â”‚
â”‚                                                                  â”‚
â”‚  Phase 1b: ë§Œë£Œëœ spec_documents ì‚­ì œ                            â”‚
â”‚            WHERE created_at + retention_days < NOW()             â”‚
â”‚                                                                  â”‚
â”‚  Phase 2:  ê³ ì•„ analyses ì‚­ì œ                                    â”‚
â”‚            WHERE user_analysis_history ì°¸ì¡° ì—†ìŒ                  â”‚
â”‚            AND created_at < NOW() - 1 day (ìœ ì˜ˆ ê¸°ê°„)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ë°”ì´ë„ˆë¦¬ ì•„í‚¤í…ì²˜

```
cmd/retention-cleanup/
â”œâ”€â”€ main.go                    # ì§„ì…ì , run-to-completion
â””â”€â”€ (bootstrap via internal/)

src/internal/
â”œâ”€â”€ domain/retention/
â”‚   â”œâ”€â”€ errors.go              # ë„ë©”ì¸ ì˜¤ë¥˜
â”‚   â”œâ”€â”€ policy.go              # ë§Œë£Œ ê³„ì‚°
â”‚   â””â”€â”€ repository.go          # CleanupRepository ì¸í„°í˜ì´ìŠ¤
â”œâ”€â”€ usecase/retention/
â”‚   â””â”€â”€ cleanup.go             # CleanupUseCase ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜
â””â”€â”€ adapter/repository/postgres/
    â””â”€â”€ retention.go           # PostgreSQL êµ¬í˜„
```

### CleanupRepository ì¸í„°í˜ì´ìŠ¤

```go
type CleanupRepository interface {
    DeleteExpiredUserAnalysisHistory(ctx context.Context, batchSize int) (DeleteResult, error)
    DeleteExpiredSpecDocuments(ctx context.Context, batchSize int) (DeleteResult, error)
    DeleteOrphanedAnalyses(ctx context.Context, batchSize int) (DeleteResult, error)
}

type DeleteResult struct {
    DeletedCount int64
    HasMore      bool
}
```

### Railway ì„¤ì •

```json
{
  "$schema": "https://railway.com/railway.schema.json",
  "build": {
    "builder": "DOCKERFILE",
    "dockerfilePath": "infra/retention-cleanup/Dockerfile"
  },
  "deploy": {
    "cronSchedule": "0 3 * * *",
    "restartPolicyType": "NEVER"
  }
}
```

## ê²€í† ëœ ëŒ€ì•ˆ

### ì˜µì…˜ A: ê°œë³„ ë°”ì´ë„ˆë¦¬ + Railway Cron (ì„ íƒë¨)

Railway Cron í†µí•´ ë§¤ì¼ ì‹¤í–‰ë˜ëŠ” ë…ë¦½ Go ë°”ì´ë„ˆë¦¬.

**ì¥ì **:

- ë‹¤ë¥¸ ì›Œí¬ë¡œë“œì™€ ì¥ì•  ê²©ë¦¬
- ë…ë¦½ì  ë°°í¬ ë° ì„¤ì •
- 24/7 ì‹¤í–‰ ë¹„ìš© ì—†ìŒ (ì‹¤í–‰ë‹¹ ê³¼ê¸ˆ)
- Railwayì˜ ìŠ¤ì¼€ì¤„ë§ ì‹ ë¢°ì„± í™œìš©

**ë‹¨ì **:

- ì½œë“œ ìŠ¤íƒ€íŠ¸ ì§€ì—° (~10-30ì´ˆ)
- Railway í”Œë«í¼ ì¢…ì†ì„±
- ê´€ë¦¬í•  ë°”ì´ë„ˆë¦¬ ì¶”ê°€

### ì˜µì…˜ B: Scheduler ì„œë¹„ìŠ¤ ë‚´ì¥ (ì´ì „ ë°©ì‹)

ì¤‘ì•™ ì§‘ì¤‘ì‹ Scheduler ë‚´ í¬ë¡  ì‘ì—…ìœ¼ë¡œ ì •ë¦¬ ë¡œì§ í¬í•¨.

**ì¥ì **:

- ë‹¨ì¼ ì„œë¹„ìŠ¤ ëª¨ë‹ˆí„°ë§
- ì›œ ì‹¤í–‰ (ì½œë“œ ìŠ¤íƒ€íŠ¸ ì—†ìŒ)

**ë‹¨ì **:

- [ADR-22](/ko/adr/22-scheduler-removal-railway-cron.md)ì— ë”°ë¼ Scheduler ì œê±°ë¨
- ì¼ì¼ ì‘ì—…ì— 24/7 ì‹¤í–‰ ë¹„ìš©

### ì˜µì…˜ C: PostgreSQL pg_cron í™•ì¥

ë°ì´í„°ë² ì´ìŠ¤ ë ˆë²¨ ì˜ˆì•½ ì‘ì—….

**ì¥ì **:

- ì• í”Œë¦¬ì¼€ì´ì…˜ ë°”ì´ë„ˆë¦¬ ë¶ˆí•„ìš”
- ë„¤ì´í‹°ë¸Œ PostgreSQL ì†”ë£¨ì…˜

**ë‹¨ì **:

- Railway Postgresì—ì„œ pg_cron ì‚¬ìš© ë¶ˆê°€
- SQLë¡œ ë³µì¡í•œ í‹°ì–´ ì¸ì‹ ë¡œì§ êµ¬í˜„ ì–´ë ¤ì›€
- ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ ë¡œê¹… ë¶ˆê°€

### ì˜µì…˜ D: ì •ë¦¬ ì‹œì  í˜„ì¬ í”Œëœ ì¡°íšŒ

ìƒì„± ì‹œ ì €ì¥ ëŒ€ì‹  ì •ë¦¬ ì‹œ ì‚¬ìš©ìì˜ í˜„ì¬ í”Œëœ ì¡°íšŒ.

**ì¥ì **:

- ìŠ¤í‚¤ë§ˆ ë³€ê²½ ë¶ˆí•„ìš”
- í•­ìƒ í˜„ì¬ í‹°ì–´ ë°˜ì˜

**ë‹¨ì **:

- **ë‹¤ìš´ê·¸ë ˆì´ë“œ ë¶ˆê³µì •**: ì‚¬ìš©ìê°€ Freeë¡œ ë‹¤ìš´ê·¸ë ˆì´ë“œ ì‹œ Pro ë°ì´í„° ì¦‰ì‹œ ì‚­ì œ
- ë³´ì¡´ ë¹„ìš©ì„ ì§€ë¶ˆí•œ ë°ì´í„° ì†ì‹¤

## ê²°ê³¼

### ê¸ì •ì 

| ì˜ì—­                | ì´ì                               |
| ------------------- | --------------------------------- |
| ìŠ¤í† ë¦¬ì§€ ìµœì í™”     | ë¬´ì œí•œ í…Œì´ë¸” ì¦ê°€ ë°©ì§€           |
| ì¿¼ë¦¬ ì„±ëŠ¥           | ì‘ì€ í…Œì´ë¸”ë¡œ ì¸ë±ìŠ¤ íš¨ìœ¨ì„± ìœ ì§€  |
| ë¹„ìš© í†µì œ           | ì‹¤í–‰ë‹¹ ê³¼ê¸ˆ (24/7 í”„ë¡œì„¸ìŠ¤ ì—†ìŒ)  |
| ë‹¤ìš´ê·¸ë ˆì´ë“œ ê³µì •ì„± | ê¸°ì¡´ ë°ì´í„°ëŠ” ì›ë˜ ë³´ì¡´ ê¸°ê°„ ìœ ì§€ |
| ì»´í”Œë¼ì´ì–¸ìŠ¤ ì¤€ë¹„   | ìë™ ë°ì´í„° ìƒëª…ì£¼ê¸° ê´€ë¦¬         |
| ê°ì‚¬ ì¶”ì            | ì‹¤í–‰ë‹¹ ì‚­ì œ ê±´ìˆ˜ ë¡œê¹…             |

### ë¶€ì •ì 

| ì˜ì—­            | íŠ¸ë ˆì´ë“œì˜¤í”„                         |
| --------------- | ------------------------------------ |
| ìŠ¤ì¼€ì¤„ë§ ì„¸ë¶„í™” | ì¼ì¼ ìµœì†Œ (Railway Cron ì œí•œ)        |
| ì½œë“œ ìŠ¤íƒ€íŠ¸     | ì‹¤í–‰ë‹¹ 10-30ì´ˆ ì‹œì‘ ì˜¤ë²„í—¤ë“œ         |
| í”Œë«í¼ ì¢…ì†ì„±   | Railwayì— ìŠ¤ì¼€ì¤„ë§ ì¢…ì†              |
| ìŠ¤í‚¤ë§ˆ ì¶”ê°€     | ì“°ê¸° ë¹ˆë„ ë†’ì€ í…Œì´ë¸”ì— ìƒˆ ì»¬ëŸ¼ ì¶”ê°€ |

### ê¸°ìˆ  ì°¸ê³ 

- **ì‚­ì œ ìˆœì„œ**: Phase 1ì„ Phase 2 ì „ì— ì‹¤í–‰ (ì™¸ë˜ í‚¤ ì¸ì‹)
- **ë°°ì¹˜ ì²˜ë¦¬**: ì„¤ì • ê°€ëŠ¥í•œ ë°°ì¹˜ í¬ê¸° ë° ìŠ¬ë¦½ ê°„ê²©
- **íƒ€ì„ì•„ì›ƒ**: Railway ì‹¤í–‰ íƒ€ì„ì•„ì›ƒ 30ë¶„ ì„¤ì •
- **ëª¨ë‹ˆí„°ë§**: í…Œì´ë¸”ë³„ ì‚­ì œ ê±´ìˆ˜ ë¡œê¹…ìœ¼ë¡œ íŠ¸ë Œë“œ ë¶„ì„

## ì„¤ì •

```
DATABASE_URL=postgres://...
RETENTION_TIMEOUT=30m
RETENTION_BATCH_SIZE=1000
RETENTION_BATCH_SLEEP=100ms
```

## ì°¸ê³ 

- [ADR-22: Scheduler ì œê±° ë° Railway Cron ì „í™˜](/ko/adr/22-scheduler-removal-railway-cron.md) - ìƒìœ„ ì•„í‚¤í…ì²˜ ê²°ì •
- [Worker ADR-08: SpecView Worker ë°”ì´ë„ˆë¦¬ ë¶„ë¦¬](/ko/adr/worker/08-specview-worker-separation.md) - ë°”ì´ë„ˆë¦¬ ë¶„ë¦¬ íŒ¨í„´
- [ADR-13: ê³¼ê¸ˆ ë° í• ë‹¹ëŸ‰ ì•„í‚¤í…ì²˜](/ko/adr/13-billing-quota-architecture.md) - í”Œëœì˜ `retention_days` ì •ì˜
- ì»¤ë°‹: `7eb93aa`, `878d87c`, `5e8c05a`, `792f106`, `6e03a7f` (2026-02-02)
